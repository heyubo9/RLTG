if [ ! -d "./jasper-CVE-2015-5221" ]; then
    git clone https://github.com/mdadams/jasper.git jasper-CVE-2015-5221
fi
if [ -d "./jasper-CVE-2015-5221" ]; then
    cd jasper-CVE-2015-5221; #git checkout 142245b
    if [ -d "./obj-aflgo" ]; then
        cd obj-aflgo;rm -rf out
        export TMP_DIR=$PWD/temp
        $AFLGO/afl-fuzz -m none -z exp -c 45m -U -D $TMP_DIR -i in -o out src/appl/jasper -f @@ -t mif -F /tmp/out -T jpg
    fi
    mkdir obj-aflgo; mkdir obj-aflgo/temp
    export SUBJECT=$PWD; export TMP_DIR=$PWD/obj-aflgo/temp
    export SVF_DIR=$AFLGO/SVF/Release-build/bin
    export CC=$AFLGO/afl-clang-fast; export CXX=$AFLGO/afl-clang-fast++
    export LDFLAGS=-lpthread
    export ADDITIONAL="-targets=$TMP_DIR/BBtargets.txt -outdir=$TMP_DIR -flto -fuse-ld=gold -Wl,-plugin-opt=save-temps"
    # echo $'jas_tvp.c:111\nmif_cod.c:587\nmif_cod.c:497\nmif_cod.c:166\njas_image.c:372\njasper.c:229\nmif_cod.c:573\njas_tvp.c:96\nmif_cod.c:536' > $TMP_DIR/BBtargets.txt
    echo $'mif_cod.c:573' > $TMP_DIR/BBtargets.txt
    cd obj-aflgo; CFLAGS="$ADDITIONAL" CXXFLAGS="$ADDITIONAL" ../configure --disable-shared --prefix=`pwd` --host=x86_64-pc-linux
    make clean; make -j4

    #extract indirect call
    $SVF_DIR/wpa --print-fp --ander $SUBJECT/obj-aflgo/src/appl/jasper.0.0.preopt.bc >> $TMP_DIR/indirect.txt
    $AFLGO/scripts/ex_incallsite.sh $TMP_DIR/indirect.txt $TMP_DIR

    cat $TMP_DIR/BBnames.txt  | sort | uniq > $TMP_DIR/BBnames2.txt && mv $TMP_DIR/BBnames2.txt $TMP_DIR/BBnames.txt
    cat $TMP_DIR/BBcalls.txt | sort | uniq > $TMP_DIR/BBcalls2.txt && mv $TMP_DIR/BBcalls2.txt $TMP_DIR/BBcalls.txt
    cat $TMP_DIR/BBinCalls.txt | sort | uniq > $TMP_DIR/BBinCalls2.txt && mv $TMP_DIR/BBinCalls2.txt $TMP_DIR/BBinCalls.txt

    # cd src/appl; $AFLGO/scripts/genDistance.sh $SUBJECT $TMP_DIR jasper
    cd src/appl; $AFLGO/scripts/gen_distance_fast.py -p $PWD $TMP_DIR jasper
    # cd -; CFLAGS="-distance=$TMP_DIR/distance.cfg.txt" CXXFLAGS="-distance=$TMP_DIR/distance.cfg.txt" ../configure --disable-shared --prefix=`pwd`
    # make clean; make -j4
    cd -;mkdir in; echo "" > in/in
    $AFLGO/afl-fuzz -m none -z exp -c 45m -U -D $TMP_DIR -i in -o out src/appl/jasper -f @@ -t mif -F /tmp/out -T jpg
fi