if [ ! -d "./CVE-2016-9560" ]; then
    git clone https://github.com/mdadams/jasper.git CVE-2016-9560
fi
if [ -d "./CVE-2016-9560" ]; then
    cd CVE-2016-9560;# git checkout -f bdfe95a
    if [ -d "./obj-aflgo" ]; then
        cd obj-aflgo;rm -rf out
        export TMP_DIR=$PWD/temp
        $AFLGO/afl-fuzz -m none -d -z exp -c 45m -U -D $TMP_DIR -i $AFLGO/in -o out src/appl/imginfo -f @@
    else
        autoreconf -f -i
        mkdir obj-aflgo; mkdir obj-aflgo/temp
        export SUBJECT=$PWD; export TMP_DIR=$PWD/obj-aflgo/temp
        export SVF_DIR=$AFLGO/SVF/Release-build/bin
        export CC=$AFLGO/afl-clang-fast; export CXX=$AFLGO/afl-clang-fast++
        export LDFLAGS=-lpthread
        export ADDITIONAL="-targets=$TMP_DIR/BBtargets.txt -outdir=$TMP_DIR -flto -fuse-ld=gold -Wl,-plugin-opt=save-temps"
        # echo $'jas_tvp.c:111\nmif_cod.c:587\nmif_cod.c:497\nmif_cod.c:166\njas_image.c:372\njasper.c:229\nmif_cod.c:573\njas_tvp.c:96\nmif_cod.c:536' > $TMP_DIR/BBtargets.txt
        echo $'jpc_tsfb.c:191' > $TMP_DIR/BBtargets.txt
        cd obj-aflgo; CFLAGS="$ADDITIONAL" CXXFLAGS="$ADDITIONAL" ../configure --disable-shared --prefix=`pwd` --host=x86_64-pc-linux
        make clean; make -j4

        #extract indirect call
        $SVF_DIR/wpa --print-fp --ander $SUBJECT/obj-aflgo/src/appl/imginfo.0.0.preopt.bc >> $TMP_DIR/indirect.txt
        $AFLGO/scripts/ex_incallsite.sh $TMP_DIR/indirect.txt $TMP_DIR

        cat $TMP_DIR/BBnames.txt  | sort | uniq > $TMP_DIR/BBnames2.txt && mv $TMP_DIR/BBnames2.txt $TMP_DIR/BBnames.txt
        cat $TMP_DIR/BBcalls.txt | sort | uniq > $TMP_DIR/BBcalls2.txt && mv $TMP_DIR/BBcalls2.txt $TMP_DIR/BBcalls.txt
        cat $TMP_DIR/BBinCalls.txt | sort | uniq > $TMP_DIR/BBinCalls2.txt && mv $TMP_DIR/BBinCalls2.txt $TMP_DIR/BBinCalls.txt

        # cd src/appl; $AFLGO/scripts/genDistance.sh $SUBJECT $TMP_DIR jasper
        cd src/appl; $AFLGO/scripts/gen_distance_fast.py -p $PWD $TMP_DIR imginfo
        # cd -; CFLAGS="-distance=$TMP_DIR/distance.cfg.txt" CXXFLAGS="-distance=$TMP_DIR/distance.cfg.txt" ../configure --disable-shared --prefix=`pwd`
        # make clean; make -j4
        cd -;mkdir in; echo "" > in/in
        $AFLGO/afl-fuzz -m none -z exp -c 45m -U -D $AFLGO/CVE-2016-9560/obj-aflgo/temp -i $AFLGO/in -o out $AFLGO/CVE-2016-9560/obj-aflgo/src/appl/imginfo -f @@
    fi
fi
